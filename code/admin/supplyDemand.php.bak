<?php
/**
 * supplyDemand.php(供求模块)
 * @author xiongzhixin (xzx747@sohu.com) 2007-06-23
 */

//define("OPEN_DEBUG",true);
require_once("../class/common.inc.php");
include "../js/editor/fckeditor.php";

$sAction = (isset($_GET["act"])) ? $_GET["act"] : "listAll";
if($sAction <> "showPage") checkExecPower("supplyDemand", $sAction);		//权限检查
loadLib("category");

$sTbl = "supplyDemand";
$sClass = $sTbl."_class";

$tpl->assign("PAGE_FUNC_BIG_LINK", "supplyDemand.php");
$tpl->assign("PAGE_FUNC_BIG_NAME", "供求管理");

$tpl->assign("__SUPPLYDEMAND_HTM",__SUPPLYDEMAND_HTM);
$tpl->assign("__SUPPLYDEMAND_PIC",__SUPPLYDEMAND_PIC);

if($sAction == "edit" && isset($_GET['id'])) // 修改
{	
	$id = $_GET['id'];
	$tpl->assign("PAGE_FUNC_SMALL_NAME","编辑供求");
	$sSQL = "SELECT * FROM $sTbl WHERE id=$id";
	$aField = $db->getRecordSet($sSQL,1);		
	//print_r($aField);
	$oFCKeditor = new FCKeditor('FCKeditor1') ; 
	$oFCKeditor->BasePath = "../js/editor/" ; 
	$oFCKeditor->ToolbarSet = "Default" ; 
	$oFCKeditor->InstanceName = "content" ; 
	$oFCKeditor->Width = "90%" ; 
	$oFCKeditor->Height = "400" ; 
	$oFCKeditor->Value = $aField['content'];
	$sContent = $oFCKeditor->Create() ; 
	$tpl->assign("sContent",$sContent);
	
	//行业
	$sHangyeOptions = category::getCatOptions("hangye",1,$aField['hangyeID']);
	$tpl->assign("sHangyeOptions",$sHangyeOptions);
	
	$tpl->assign("aField",$aField);
	$tpl->display("admin/supplyDemand_edit.tpl.htm");
}
elseif ($sAction == "editSave" && isset($_POST['id'])) // 修改保存
{
	$id = $_POST['id'];
	$iStatus = $_POST['status'];//状态值
	$aField['type'] = $_POST['type1'];
	$aField['hangyeID'] = $_POST['hangyeID'];
	$aField['name'] = $_POST['name'];
	$aField['keywords'] = $_POST['keywords'];
	$aField['endDate'] = $_POST['endDate'];
	$aField['specifications'] = $_POST['specifications'];
	$aField['quantity'] = $_POST['quantity'];	
	$aField['package'] = $_POST['package'];	
	$aField['price'] = $_POST['price'];	
	$aField['content'] = $_POST['content'];		
	$aField['status'] = $iStatus;//新的状态值
	
	
	if($_FILES['pic']['name'])
	{		
		loadLib("pic");
		$pic = new pic(__SUPPLYDEMAND_PIC);
		$sPicName = $pic->uploadPic("pic");	
		
		//处理图片		
		$sSmallPicName = $pic->makeThumb($sPicName,$aThumbSize['width'], $aThumbSize['height']); // 缩略图)		
		$aField['pic'] = $sSmallPicName;		
		unlink(__SUPPLYDEMAND_PIC.$_POST['oldPic']);
		$aField['pic'] = $sSmallPicName;
	}
	elseif($_POST['delPic']) // 删除图片
	{
		unlink(__SUPPLYDEMAND_PIC.$_POST['oldPic']);	
		$aField['pic'] = "";
	}	
		
	//print_r($aField);exit;
	if($iStatus ==1)
	{
		createHtm(__SUPPLYDEMAND_HTM,$_POST['fileName'],$id);//生成新文件
	}
	if($iStatus <> 1 && $_POST['oldstatus'] == 1 )
	{
		unlink(__SUPPLYDEMAND_HTM,$_POST['fileName']);//删除旧文件
	}
	
	if($db->update($sTbl,$aField,"id=$id"))
	{
		//$iStatus = $_POST['oldStatus'];		
		//if($iStatus == 1) createHtm(__SUPPLYDEMAND_HTM,$_POST['fileName'],$id); // 如果修改的是已审核信息则同时生成新页面				
		redirect("supplyDemand.php?act=listAll&status=".$iStatus,3,"修改成功！");	
	}
	else 
	{
		redirect("supplyDemand.php?act=edit&id=".$id,3,"修改失败！");
	}	
}
elseif ($sAction == "listAll")  // 列表
{
	$aHangyeList = category::getCatArrByPID(0,"hangye");
	$tpl->assign("aHangyeList",$aHangyeList);
	
	loadLib("corporation");
	$iType = isset($_REQUEST['type1']) ? $_REQUEST['type1'] : -1; //供求
	$iHangyeID = isset($_REQUEST['hangyeID']) ? $_REQUEST['hangyeID'] : 0; //行业
	$sUserName = $_REQUEST['u'];  // 企业
	
	if($iType >= 0)
	{
		$sWhere = "type='$iType'";
		$sCatName = "【".($iTyp == 0) ? "供应" : "采购"."】";				
	}
	elseif($iHangyeID > 0)
	{
		//$sWhere = "cID in".category::getSubID($sClass,$cID);
		$sWhere = "hangyeID = $iHangyeID"; 
		$sCatName = "【".category::getCatNameByID("hangye",$iHangyeID)."】";						
	}
	elseif($sUserName <> "")
	{
		//$sWhere = "cID in".category::getSubID($sClass,$cID);
		$sWhere = "userName = $sUserName"; 
		$sCatName = "【".corporation::getCompanyNameByUserName($sUserName)."】";					
	}
	else 
	{
		$sWhere = "1";
		$sCatName = "所有";
	}
	
	$tpl->assign("PAGE_FUNC_SMALL_NAME",$sCatName."供求列表");
	$iStatus = isset($_REQUEST['status']) ? $_REQUEST['status'] : -1; // -1 代表所有供求
	$q = isset($_REQUEST['q']) ? $_REQUEST['q'] : "";	
	
	
	$sWhere .= ($iStatus >=0) ? " AND a.status = '".$iStatus."'" : "";
	$sWhere .= $q ? " AND a.name like '%$q%'" : ""; 
	
	$iNowPage = empty($_REQUEST["pageNo"]) ? 1 : intval($_REQUEST["pageNo"]); 
	$iPerpage = isset($_REQUEST['perPage']) ? $_REQUEST['perPage'] : (defined("I_PERPAGE") ? I_PERPAGE : 10);
	$iStartNo = ($iNowPage - 1) * $iPerpage;
	//得到总数目
	
	$iTotalNum = $db->getRowsNum("SELECT COUNT(id) FROM $sTbl AS a WHERE $sWhere");	
	
	$sSQL = "SELECT * FROM $sTbl AS a WHERE $sWhere ORDER BY a.id desc LIMIT {$iStartNo}, $iPerpage";	
	$aList = $db->getRecordSet($sSQL);
	for($i=0; $i<count($aList); $i++)
	{		
		$aList[$i]['catName'] = category::getCatNameByID("supplyDemand_class",$aList[$i]['cID'],1);
		$aList[$i]['hangyeName'] = category::getCatNameByID("hangye",$aList[$i]['hangyeID'],1);
		$aInfo = corporation::getInfoByUserName($aList[$i]['userName'],"companyName,userName,is_vip,email,mobile,address,phone");
		$aList[$i] = array_merge($aList[$i],$aInfo);
	}
	//print_r($aList);exit;
	dividePage("supplyDemand.php", $iTotalNum, $iPerpage, $iNowPage, 
			   "act=listAll&type=$iType&hangyeID=$iHangyeID&userName=$sUserName&status=$iStatus&q=$q&perPage=$iPerpage");	
	
	$bHaveEditPower = manager::checkPower($_SESSION['xzx_uID'],"supplyDemand","edit");
	$tpl->assign("aList",$aList);
	$tpl->assign("iStatus",$iStatus);
	$tpl->assign("q",$q);
	$tpl->assign("bHaveEditPower",$bHaveEditPower);
	$tpl->assign("iPageNo",$iNowPage);
	$tpl->assign("iType",$iType);
	$tpl->assign("hangyeID",$iHangyeID);
	$tpl->assign("userName",$sUserName);
	$tpl->assign("__SUPPLYDEMAND_PIC",__SUPPLYDEMAND_PIC);
	$tpl->assign("__SUPPLYDEMAND_HTM",__SUPPLYDEMAND_HTM);	
	$tpl->display("admin/supplyDemand_list.tpl.htm");
}
elseif($sAction == "recycle") // 放入回收站
{	
	$iStatus = $_REQUEST['status'];
	$sID = array2Set($_POST['supplyDemandID']);	
	//echo $sID;
	//EXIT;
	$sSQL = "SELECT id,fileName FROM $sTbl WHERE id in $sID";
	$aList = $db->getRecordSet($sSQL);
	for($i=0; $i<count($aList); $i++)
	{
		@unlink(__SUPPLYDEMAND_HTM.$aList[$i]['fileName']); // 删除静态页面
	}
	if($db->query("UPDATE $sTbl SET status='2' WHERE id in $sID"))
	{
		redirect("supplyDemand.php?act=listAll&type=$iType&status=$iStatus",3,"成功放入回收站！");
	}	
	else
	{
		redirect("supplyDemand.php?act=listAll&type=$iType&status=$iStatus",5,"放入回收站失败！");
	}	
}
elseif($sAction == "uncheck") // 设为未审核
{	
	$iStatus = $_REQUEST['status'];
	$sID = array2Set($_POST['supplyDemandID']);	
	$sSQL = "SELECT id,fileName FROM $sTbl WHERE id in $sID";
	$aList = $db->getRecordSet($sSQL);
	for($i=0; $i<count($aList); $i++)
	{
		@unlink(__SUPPLYDEMAND_HTM.$aList[$i]['fileName']); // 删除静态页面
	}
	if($db->query("UPDATE $sTbl SET status='0' WHERE id in $sID"))
		redirect("supplyDemand.php?act=listAll&type=$iType&status=$iStatus",3,"成功设为未审核！");
	else
		redirect("supplyDemand.php?act=listAll&type=$iType&status=$iStatus",5,"设为未审核失败！");
}
elseif($sAction == "del") // 彻底删除
{
	$iStatus = $_REQUEST['status'];
	$sID = array2Set($_POST['supplyDemandID']);	
	$sSQL = "SELECT id,fileName,pic FROM $sTbl WHERE id in $sID";
	$aList = $db->getRecordSet($sSQL);
	for($i=0; $i<count($aList); $i++)
	{
		@unlink(__SUPPLYDEMAND_HTM.$aList[$i]['fileName']); // 删除静态页面
		@unlink(__SUPPLYDEMAND_PIC.$aList[$i]['pic']);
	}
	if($db->query("delete FROM $sTbl WHERE id in $sID"))
		redirect("supplyDemand.php?act=listAll&type=$iType&status=$iStatus",3,"删除成功！");
	else
		redirect("supplyDemand.php?act=listAll&type=$iType&status=$iStatus",5,"删除失败！");		
}
elseif($sAction == "check" || $sAction == "recommend") // 审核或推荐
{	
	$iStatus = $_REQUEST['status'];
	$sID = array2Set($_POST['supplyDemandID']);	
	$sSQL = "SELECT id,fileName FROM $sTbl WHERE id in $sID";
	$aList = $db->getRecordSet($sSQL);
	$iSuc = $iErr = 0;
	$iNewStatus = ($sAction == "check") ? "1" : "3";

	for($i=0; $i<count($aList); $i++)
	{
		$iID = $aList[$i]['id'];
		if(createHtm(__SUPPLYDEMAND_HTM,$aList[$i]['fileName'],$iID,$sTbl)) // 生成静态页面
		{
			$db->query("UPDATE $sTbl SET status='$iNewStatus' WHERE id=$iID");
			$iSuc ++;
		}
		else 
			$iErr ++;
	}
	
	$sStr = ($sAction == "check") ? "审核" : "推荐";

	redirect("supplyDemand.php?act=listAll&type=$iType&status=$iStatus",3,"{$sStr}成功，页面生成成功数:<font color=blue>".$iSuc."</font>；错误数：<font color=red>".$iErr."</font>！");	
}
elseif($sAction == "showPage" && isset($_GET['id']))
{	

	$id = $_GET['id'];		
	$sSQL = "SELECT * FROM $sTbl WHERE id = $id";
	$aField = $db->getRecordSet($sSQL,1);		

	//获取发布该供求信息的企业资料
	$sSQL = " select * from corporation where userName='".$aField['userName']."' ";
	$aCorporation = $db->getRecordSet($sSQL,1);
	//企业性质
	$tpl->assign("aCompanyNation",$aCompanyNation);

	//获取该企业发布的其他供求信息
	$sSQL = " select * from $sTbl where userName = '".$aField['userName']."' and (status = '1' or status='3') order by id desc limit 0,4 ";
	$aOtherSupplyDemand = $db->getRecordSet($sSQL);
	$tpl->assign("aOtherSupplyDemand",$aOtherSupplyDemand);
	
	//行业
	$aHangye = category::getCatArrByPID(0,"hangye");  // 行业	

	$tpl->assign("aHangye",$aHangye);	
		
	//$aField['catName'] = category::getCatNameByID($sClass,$aField['cID']);	
	$sPageTitle = $aField['name']."－－供求信息－－中国金信商务联盟";
	
	$tpl->assign("sPageTitle",$sPageTitle);
	
	$tpl->assign("aField",$aField);
	$tpl->assign("aCorporation",$aCorporation);		
	$tpl->assign("sTbl",$sTbl);	
	$tpl->display("html/supplyDemand_detail.tpl.htm");	
		
}
elseif($sAction == "makeStatic" && isset($_GET['id'])) // 单个页面生成
{
	$id = $_GET['id'];	
	$aField = $db->getRecordSet("SELECT fileName FROM $sTbl WHERE id=$id",1);
	//print_r($aField);

	if(createHtm(__SUPPLYDEMAND_HTM,$aField['fileName'],$id,$sTbl)) // 生成静态页面
	{	
		redirect(__SUPPLYDEMAND_HTM."/".$aField['fileName'],3,"页面生成成功！");
	}
	else
	{
		redirect(__SUPPLYDEMAND_HTM."/".$aField['fileName'],5,"页面生成失败！");
	}
}
else
{
	showError("参数错误");
}
?>